name: ZMK Fully Manual Dependency Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    container:
      image: zmkfirmware/zmk-build-arm:stable
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: ‚¨áÔ∏è Checkout Repository (Your Config)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: ‚öôÔ∏è Manual Git Clone and CMake Build (Final Resilient Script)
        shell: bash
        run: |
          # --- Configuration Variables ---
          ZEPHYR_REVISION="v2.6.0" 
          MCUB_REVISION="v1.7.0"
          ZMK_REVISION="v0.3" 
          ZMK_REPO_ROOT="$GITHUB_WORKSPACE/zmk"
          
          # --- Path Definitions ---
          ZEPHYR_DIR="$ZMK_REPO_ROOT/zephyr"
          ZEPHYR_ENV_SCRIPT="$ZEPHYR_DIR/zephyr-env.sh"
          APP_REPO_DIR="$ZMK_REPO_ROOT/app" # ZMK Clone Root
          
          # 1. Create the base ZMK structure
          echo "--- 1. Creating target directories ---"
          mkdir -p "$ZEPHYR_DIR" || { echo "FATAL: Failed to create Zephyr directory."; exit 1; }
          mkdir -p "$APP_REPO_DIR" || { echo "FATAL: Failed to create ZMK app directory."; exit 1; }
          mkdir -p "$ZMK_REPO_ROOT/bootloader/mcuboot" || { echo "FATAL: Failed to create MCUBoot directory."; exit 1; }

          # 2. Clone Dependencies (Error Handled Inline)
          echo "--- 2. Cloning Dependencies ---"
          git clone --depth 1 --branch "$ZMK_REVISION" https://github.com/zmkfirmware/zmk.git "$APP_REPO_DIR" || { echo "FATAL: ZMK clone failed."; exit 1; }
          git clone --depth 1 --branch "$ZEPHYR_REVISION" https://github.com/zephyrproject-rtos/zephyr.git "$ZEPHYR_DIR" || { echo "FATAL: Zephyr clone failed."; exit 1; }
          git clone --depth 1 --branch "$MCUB_REVISION" https://github.com/mcu-tools/mcuboot.git "$ZMK_REPO_ROOT/bootloader/mcuboot" || { echo "FATAL: MCUBoot clone failed."; exit 1; }

          # 3. üîç VALIDATION CHECK: Verify critical Zephyr paths
          echo "--- 3. VALIDATING ZEPHYR ENVIRONMENT ---"
          if [ ! -d "$ZEPHYR_DIR" ]; then echo "FATAL: Zephyr base directory not found at $ZEPHYR_DIR"; exit 1; }
          if [ ! -f "$ZEPHYR_ENV_SCRIPT" ]; then echo "FATAL: Zephyr environment script not found at $ZEPHYR_ENV_SCRIPT"; exit 1; }
          echo "TRACE: All environment checks passed."

          # 4. Sourcing Zephyr Environment (Error Handled Inline)
          echo "--- 4. Sourcing Zephyr Environment Variables ---"
          . "$ZEPHYR_ENV_SCRIPT" || { echo "FATAL: zephyr-env.sh sourcing failed."; exit 1; }

          # 5. Build Setup and CMake Execution
          echo "--- 5. Starting Final CMake Build ---"
          
          # --- Runtime Path Definitions ---
          BUILD_DIR="$APP_REPO_DIR/build"
          APP_SOURCE_DIR="$APP_REPO_DIR" # Initial assumption
          
          # 6. BACKUP PLAN: Check for nested 'app' directory (where CMakeLists.txt resides)
          if [ -f "$APP_REPO_DIR/app/CMakeLists.txt" ]; then
             echo "TRACE: Found CMakeLists.txt in nested app directory. Adjusting source path."
             APP_SOURCE_DIR="$APP_REPO_DIR/app"
          elif [ ! -f "$APP_REPO_DIR/CMakeLists.txt" ]; then
             echo "FATAL: Cannot find CMakeLists.txt in either '$APP_REPO_DIR' or '$APP_REPO_DIR/app'."
             ls -l "$APP_REPO_DIR"
             exit 1
          else
             echo "TRACE: Found CMakeLists.txt in expected top-level ZMK app directory."
          fi

          # 7. Execute CMake
          echo "TRACE: Source Directory Final Path: $APP_SOURCE_DIR"
          
          # A. CMake Configure Step (FINAL FIX: Setting BOARD_ROOT to the correct ZMK app directory)
          cmake -B "$BUILD_DIR" \
            -GNinja \
            -DBOARD=nrf52840dk_nrf52840 \
            -DSHIELD=crkbd_left \
            -DZMK_CONFIG="$GITHUB_WORKSPACE/config" \
            -DZEPHYR_BASE="$ZEPHYR_DIR" \
            -DCMAKE_PREFIX_PATH="$ZEPHYR_DIR" \
            -DZEPHYR_DIR="$ZEPHYR_DIR" \
            -DBOARD_ROOT="$APP_SOURCE_DIR" \
            -S "$APP_SOURCE_DIR" || { echo "FATAL: CMake configuration failed. Review logs for board/shield errors."; exit 1; }
            
          # B. CMake Build Execution Step (Error Handled Inline)
          echo "TRACE: Executing build in directory: $BUILD_DIR"
          cmake --build "$BUILD_DIR" || { echo "FATAL: Build execution failed. Compilation error."; exit 1; }
          
      - name: ‚¨ÜÔ∏è Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: zmk-firmware
          path: zmk/app/build/zephyr/zmk.uf2

  artifact:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Download Final Firmware Artifact
        uses: actions/download-artifact@v4
        with:
          name: zmk-firmware
          path: ./firmware-artifacts
          
      - name: üì¶ Display Artifact Contents
        run: ls -lR ./firmware-artifacts
