name: ZMK Build (Stable Direct Config + Z_DEVICE_MAX_NAME_LEN Fix)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
    permissions:
      contents: read

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Fix Git Dubious Ownership
        shell: bash
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: üß© Log ZMK & Zephyr Versions
        shell: bash
        run: |
          set -e
          echo "=== ZMK & Zephyr Version Info ==="
          git rev-parse HEAD
          git branch --show-current
          git submodule foreach 'echo $path `git rev-parse HEAD`'
          if command -v west &> /dev/null; then
            west manifest --freeze || true
          fi

      - name: üöÄ Setup, Patch, Build, and Log
        id: build_run
        shell: bash
        run: |
          set -e
          ZMK_REVISION="v0.3"
          ZMK_CLONE_DIR="$GITHUB_WORKSPACE/app_clone"
          ZMK_ROOT="$GITHUB_WORKSPACE/zmk_workspace"
          CONFIG_DIR="$GITHUB_WORKSPACE/config"
          BOARD_NAME="nice_nano_v2"
          LOG_FILE="$GITHUB_WORKSPACE/build_debug.log"

          echo "üîß Setting up workspace..." | tee -a $LOG_FILE
          git clone --branch "$ZMK_REVISION" https://github.com/zmkfirmware/zmk.git "$ZMK_CLONE_DIR" | tee -a $LOG_FILE
          mkdir -p "$ZMK_ROOT"
          west init -m "$ZMK_CLONE_DIR" --mr "$ZMK_REVISION" --mf app/west.yml "$ZMK_ROOT" | tee -a $LOG_FILE

          cd "$ZMK_ROOT"
          west update | tee -a $LOG_FILE

          # Apply fix for Z_DEVICE_MAX_NAME_LEN if missing
          echo "üîß Applying Z_DEVICE_MAX_NAME_LEN fix..." | tee -a $LOG_FILE
          FIX_FILE="$ZMK_ROOT/zephyr/include/zephyr/device.h"
          if ! grep -q "Z_DEVICE_MAX_NAME_LEN" "$FIX_FILE"; then
            echo "#ifndef Z_DEVICE_MAX_NAME_LEN" >> "$FIX_FILE"
            echo "#define Z_DEVICE_MAX_NAME_LEN 48" >> "$FIX_FILE"
            echo "#endif" >> "$FIX_FILE"
            echo "‚úÖ Added Z_DEVICE_MAX_NAME_LEN fix" | tee -a $LOG_FILE
          else
            echo "‚ÑπÔ∏è Z_DEVICE_MAX_NAME_LEN already defined" | tee -a $LOG_FILE
          fi

          # Copy configuration files
          mkdir -p "$ZMK_ROOT/app"
          cp -r "$ZMK_CLONE_DIR/app/"* "$ZMK_ROOT/app"
          cp "$CONFIG_DIR/$BOARD_NAME.keymap" "$ZMK_ROOT/app/" || true
          cp "$CONFIG_DIR/$BOARD_NAME.overlay" "$ZMK_ROOT/app/" || true

          echo "--- DUMPING $BOARD_NAME.overlay ---" | tee -a $LOG_FILE
          cat -n "$ZMK_ROOT/app/$BOARD_NAME.overlay" || echo "(no overlay found)" | tee -a $LOG_FILE
          echo "----------------------------------" | tee -a $LOG_FILE

          echo "üåø Sourcing Zephyr environment..." | tee -a $LOG_FILE
          . "$ZMK_ROOT/zephyr/zephyr-env.sh"

          echo "‚öôÔ∏è Starting west build..." | tee -a $LOG_FILE
          west build -b "$BOARD_NAME" "$ZMK_ROOT/app" --pristine 2>&1 | tee -a $LOG_FILE || echo "‚ùå Build failed" | tee -a $LOG_FILE

          echo "üîç Checking for firmware artifacts..." | tee -a $LOG_FILE
          find "$ZMK_ROOT/build/zephyr" -maxdepth 1 -type f -printf '%f\n' | tee -a $LOG_FILE

          # Save build status
          if [ -f "$ZMK_ROOT/build/zephyr/zmk.uf2" ]; then
            echo "FIRMWARE_PATH=$ZMK_ROOT/build/zephyr/zmk.uf2" >> $GITHUB_ENV
            echo "BUILD_STATUS=0" >> $GITHUB_ENV
          elif [ -f "$ZMK_ROOT/build/zephyr/zmk.hex" ]; then
            echo "FIRMWARE_PATH=$ZMK_ROOT/build/zephyr/zmk.hex" >> $GITHUB_ENV
            echo "BUILD_STATUS=0" >> $GITHUB_ENV
          elif [ -f "$ZMK_ROOT/build/zephyr/zmk.bin" ]; then
            echo "FIRMWARE_PATH=$ZMK_ROOT/build/zephyr/zmk.bin" >> $GITHUB_ENV
            echo "BUILD_STATUS=0" >> $GITHUB_ENV
          else
            echo "BUILD_STATUS=1" >> $GITHUB_ENV
            echo "‚ùå No firmware artifact found!" | tee -a $LOG_FILE
          fi

      - name: üíæ Upload Build Debug Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-debug-logs
          path: ${{ github.workspace }}/build_debug.log
          retention-days: 2

      - name: üíæ Upload Devicetree Debug Logs (on failure)
        if: env.BUILD_STATUS == '1'
        uses: actions/upload-artifact@v4
        with:
          name: devicetree-debug
          path: ${{ github.workspace }}/zmk_workspace/build/zephyr/zephyr.dts*
          retention-days: 2

      - name: ‚¨ÜÔ∏è Upload Firmware (on success)
        if: env.BUILD_STATUS == '0'
        uses: actions/upload-artifact@v4
        with:
          name: zmk-firmware
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 5
