name: ZMK Build: Standard Shield Configuration (Final Attempt)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    container:
      image: zmkfirmware/zmk-build-arm:stable
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: ⬇️ Checkout Repository (Your Config)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: ⚙️ West-Managed Build with Standard Configuration
        shell: bash
        run: |
          # --- Configuration Variables ---
          ZMK_REVISION="v0.3" 
          ZMK_CLONE_DIR="$GITHUB_WORKSPACE/app_clone"
          ZMK_ROOT="$GITHUB_WORKSPACE/zmk_workspace"
          CUSTOM_CONFIG_DIR="$GITHUB_WORKSPACE/config" # Your local config folder
          BOARD_NAME="nice_nano_v2"
          
          # --- 1-4. West Setup (Skipped logging, assumed success) ---
          git clone --branch "$ZMK_REVISION" https://github.com/zmkfirmware/zmk.git "$ZMK_CLONE_DIR" || exit 1
          mkdir -p "$ZMK_ROOT"
          west init -m "$ZMK_CLONE_DIR" --mr "$ZMK_REVISION" --mf app/west.yml "$ZMK_ROOT" || exit 1
          cd "$ZMK_ROOT"
          west update || exit 1
          
          # --- 5. Prepare Application and Apply ALL Fixes ---
          echo "--- 1. Copying Application Source and Configuring Files ---"
          
          # Copy ZMK app contents
          mkdir -p "$ZMK_ROOT/app"
          cp -r "$ZMK_CLONE_DIR/app/"* "$ZMK_ROOT/app" || exit 1

          # --- FIX 1: Ensure the Keymap loads by moving/renaming the file ---
          # We use the board name as the shield name for simplicity
          SHIELD_NAME="mediapad" # We'll call the shield "mediapad"
          SHIELD_DIR="$ZMK_ROOT/app/boards/shields/$SHIELD_NAME"
          mkdir -p "$SHIELD_DIR"
          
          # Copy Keymap as shield definition file
          cp "$CUSTOM_CONFIG_DIR/mediapad3.keymap" "$SHIELD_DIR/$SHIELD_NAME.keymap" || { echo "FATAL: Keymap file missing or failed copy."; exit 1; }
          echo "TRACE: Keymap copied to $SHIELD_DIR/$SHIELD_NAME.keymap"
          
          # Create a dummy config file to tell ZMK to enable our kscan config
          echo "CONFIG_ZMK_KEYMAP_NAME=\"$SHIELD_NAME\"" > "$SHIELD_DIR/$SHIELD_NAME.conf"
          echo "TRACE: Created shield config file."
          
          # --- FIX 2: Apply the Overlay Fix (Missing rows/columns) ---
          
          # Copy the overlay to the SHIELD directory for standard shield processing
          OVERLAY_DEST="$SHIELD_DIR/$SHIELD_NAME.overlay"
          cp "$CUSTOM_CONFIG_DIR/$BOARD_NAME.overlay" "$OVERLAY_DEST" || { echo "FATAL: Overlay file failed copy."; exit 1; }
          
          # PATCH: Force the rows and columns properties to resolve compilation errors
          if ! grep -q "rows" "$OVERLAY_DEST"; then
              echo "Patching overlay with missing rows=<1> and columns=<3> properties..."
              sed -i '/kscan_0:/a \ \ \ \ \ \ \ \ rows = <1>;\n\ \ \ \ \ \ \ \ columns = <3>;' "$OVERLAY_DEST"
          fi
          echo "TRACE: Overlay copied and patched with matrix size fix."

          # --- 6. Source Zephyr Environment ---
          echo "--- 2. Sourcing Zephyr Environment Variables ---"
          . "$ZMK_ROOT/zephyr/zephyr-env.sh" || { echo "FATAL: zephyr-env.sh sourcing failed."; exit 1; }

          # --- 7. Build and Configure ---
          echo "--- 3. Starting Final West Build (Using SHIELD) ---"
          
          # Use the shield flag to load our custom files
          west build -b $BOARD_NAME "$ZMK_ROOT/app" -- -DSHIELD=$SHIELD_NAME || { 
            echo "FATAL: West build failed."
            exit 1
          }
          
      - name: ⬆️ Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: zmk-firmware
          path: ${{ github.workspace }}/zmk_workspace/build/zephyr/zmk.uf2
