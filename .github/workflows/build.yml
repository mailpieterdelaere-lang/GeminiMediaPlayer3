name: ZMK Fully Manual Dependency Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # Uses the official ZMK build environment container
    container:
      image: zmkfirmware/zmk-build-arm:stable
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: ‚¨áÔ∏è Checkout Repository (Your Config)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: ‚öôÔ∏è Manual Git Clone and CMake Build (Final Resilient Script)
        # Final fix: Must use 'bash' shell for sourcing zephyr-env.sh
        shell: bash
        run: |
          # --- Dependencies and Versions (Based on your west.yml's v0.3) ---
          ZEPHYR_REVISION="v2.6.0" 
          MCUB_REVISION="v1.7.0"
          ZMK_REVISION="v0.3" 

          # 1. Create the base ZMK structure
          echo "--- 1. Creating target directories ---"
          mkdir -p "$GITHUB_WORKSPACE/zmk/zephyr"
          mkdir -p "$GITHUB_WORKSPACE/zmk/app"
          mkdir -p "$GITHUB_WORKSPACE/zmk/bootloader/mcuboot"

          # 2. Clone ZMK App
          echo "--- 2. Cloning ZMK App (Path: zmk/app) ---"
          git clone --depth 1 --branch "$ZMK_REVISION" https://github.com/zmkfirmware/zmk.git "$GITHUB_WORKSPACE/zmk/app" || exit 1
          
          # 3. Clone Zephyr (The main RTOS)
          echo "--- 3. Cloning Zephyr RTOS (Path: zmk/zephyr) ---"
          git clone --depth 1 --branch "$ZEPHYR_REVISION" https://github.com/zephyrproject-rtos/zephyr.git "$GITHUB_WORKSPACE/zmk/zephyr" || exit 1

          # 4. Clone MCUBoot (Required Bootloader)
          echo "--- 4. Cloning MCUBoot (Path: zmk/bootloader/mcuboot) ---"
          git clone --depth 1 --branch "$MCUB_REVISION" https://github.com/mcu-tools/mcuboot.git "$GITHUB_WORKSPACE/zmk/bootloader/mcuboot" || exit 1

          # 5. Sourcing Zephyr Environment
          echo "--- 5. Sourcing Zephyr Environment Variables ---"
          # This command sets ZEPHYR_BASE and other necessary variables in the shell session
          . "$GITHUB_WORKSPACE/zmk/zephyr/zephyr-env.sh" || { echo "FATAL: zephyr-env.sh sourcing failed."; exit 1; }

          # 6. Build (Replacing 'west build' with direct 'cmake' calls)
          echo "--- 6. Starting Final CMake Build ---"
          # Navigate into the ZMK application root
          cd "$GITHUB_WORKSPACE/zmk/app" || exit 1

          # A. CMake Configure Step: Sets the board, shield, and config directory
          cmake -B build \
            -GNinja \
            -DBOARD=nice_nano_v2 \
            -DSHIELD=crkbd_left \
            -DZMK_CONFIG="$GITHUB_WORKSPACE/config" \
            -S . || { echo "FATAL: CMake configuration failed."; exit 1; }
            
          # B. CMake Build Execution Step
          cmake --build build || { echo "FATAL: Build execution failed. Review compilation logs."; exit 1; }
          
      - name: ‚¨ÜÔ∏è Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: zmk-firmware
          # The resulting UF2 file is located relative to the 'zmk/app' directory
          path: zmk/app/build/zephyr/zmk.uf2

  artifact:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Download Final Firmware Artifact
        uses: actions/download-artifact@v4
        with:
          name: zmk-firmware # Must match the upload name
          path: ./firmware-artifacts
          
      - name: üì¶ Display Artifact Contents
        run: ls -lR ./firmware-artifacts
