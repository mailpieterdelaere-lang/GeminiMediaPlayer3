name: ZMK Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # Use a standard ZMK/Zephyr Docker image for consistent environments
    container:
      image: zmkfirmware/zmk-build-arm:stable
    
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          # Fetch all history for west to work correctly
          fetch-depth: 0 

      - name: üì¶ Initialize and Update West Workspace
        # This is where the ZMK/Zephyr dependencies are fetched (including zcbor)
        run: |
          # The ZMK environment usually requires initializing from the top-level repo
          west init -l config
          # Then update to pull all modules (including zmk/zephyr)
          west update

      - name: üîç DEBUG:Check Workspace Directory Structure (Crucial Step)
        # Line 33 is likely around here, possibly the 'run:' or the start of the script.
        run: | 
          echo "--- Current Working Directory (CWD) ---"
          pwd
          
          echo "--- Listing Contents of expected zmk/zephyr/ path ---"
          ls -la zmk/zephyr/ || echo "üö® ERROR: zmk/zephyr/ directory not found or inaccessible."

      # The original failing step would be here, but we'll use the fixed command below

      - name: ‚öôÔ∏è Build ZMK Firmware (Resolution Applied)
        run: |
          # 1. Change directory into the ZMK app directory. 
          # This makes the shell's CWD correct for the Zephyr/West build system.
          cd zmk/app
          
          # 2. Run the actual build command from the zmk/app directory. 
          # Note: We now reference the config directory using the correct path.
          west build -b nice_nano_v2 -- -DSHIELD=crkbd_left -DZMK_CONFIG=$GITHUB_WORKSPACE/config
          
          # 2. Run the actual build command
          west build -b nice_nano_v2 -- -DSHIELD=crkbd_left
