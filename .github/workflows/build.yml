name: ZMK Resilient Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    container:
      image: zmkfirmware/zmk-build-arm:stable
    
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # NEW WORKAROUND: Use zmk-setup-action to handle all dependencies
      - name: ‚öôÔ∏è Set up ZMK Environment
        uses: zmkfirmware/zmk-setup-action@v2 
        # This replaces manual west init/update and sources zephyr-env.sh for you.

      # The Debug step is now obsolete as the action should guarantee the files exist.
      # We skip it for a cleaner build but leave it commented for future debugging.
      #- name: üîç DEBUG: Check Workspace Directory Structure
      #  ...

      - name: ‚öôÔ∏è Build ZMK Firmware (Simplified via Action)
        # Note the '-s zmk/app' argument is used to specify the source directory.
        run: |
          west build -s zmk/app -b nice_nano_v2 -- -DSHIELD=crkbd_left -DZMK_CONFIG=$GITHUB_WORKSPACE/config || { echo "FATAL: West build failed. Review CMake output."; exit 1; }

      - name: ‚¨ÜÔ∏è Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: zmk-firmware
          # The artifact path remains relative to the workspace root
          path: build/zephyr/zmk.uf2
