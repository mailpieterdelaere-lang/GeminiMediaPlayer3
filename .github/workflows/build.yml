name: ZMK Build:Direct Configuration (Stable CI)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
    permissions:
      contents: read
      
    steps:
      - name: ‚¨áÔ∏è Checkout Repository (Your Config)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: üöÄ Setup, Build, and Log Collection
        id: build_all
        shell: bash
        run: |
          # --- Configuration Variables ---
          ZMK_REVISION="v0.3"
          # Clone ZMK and initialize West directly inside it
          ZMK_DIR="./zmk" 
          CUSTOM_CONFIG_DIR="./config"
          BOARD_NAME="nice_nano_v2"
          
          # 1. Clone ZMK and Initialize West
          echo "--- 1. Setting up West Workspace ---"
          # Clone the ZMK repository containing the manifest file
          git clone --branch "$ZMK_REVISION" https://github.com/zmkfirmware/zmk.git "$ZMK_DIR" || exit 1

          # Change directory to the cloned ZMK directory
          cd "$ZMK_DIR" || exit 1
          
          # Initialize west with the local manifest (app/west.yml)
          west init -l app || exit 1
          west update || exit 1
          
          # 2. Prepare Application Source and Copy Config
          echo "--- 2. Preparing Application Source and Configuration ---"
          # Create and copy the ZMK app source to the workspace root
          mkdir -p "$GITHUB_WORKSPACE/app"
          cp -r ./app/* "$GITHUB_WORKSPACE/app/" || exit 1

          # Copy your custom config files (keymap/overlay) to the app root
          cp -r "$GITHUB_WORKSPACE/$CUSTOM_CONFIG_DIR"/* "$GITHUB_WORKSPACE/app/"
          
          # Return to the root workspace for subsequent commands
          cd "$GITHUB_WORKSPACE" || exit 1 
          
          # 3. Source Zephyr Environment
          echo "--- 3. Sourcing Zephyr Environment Variables ---"
          . "$ZMK_DIR/zephyr/zephyr-env.sh" || { echo "FATAL: zephyr-env.sh sourcing failed."; exit 1; }

          # 4. Perform West Build and Capture Status
          echo "--- 4. Starting Final West Build ---"
          
          # Build from the current workspace root, targeting the 'app' folder
          west build -b $BOARD_NAME ./app
          
          BUILD_STATUS=$?
          
          # Pass build status to be used by subsequent steps
          echo "BUILD_STATUS=$BUILD_STATUS" >> $GITHUB_OUTPUT
          
          if [ $BUILD_STATUS -ne 0 ]; then
             echo "FATAL: West build failed. Log upload will proceed."
          fi
          
      # üíæ Upload Devicetree Preprocessor Logs (On Failure)
      - name: üíæ Upload Devicetree Preprocessor Logs (On Failure)
        uses: actions/upload-artifact@v4
        if: ${{ steps.build_all.outputs.BUILD_STATUS != '0' }}
        with:
          name: devicetree-debug-logs
          # Path uses the standard './build' directory relative to the current workspace
          path: ${{ github.workspace }}/build/zephyr/zephyr.dts.pre
          retention-days: 1

      # ‚¨ÜÔ∏è Upload Final Artifacts (Runs on Success)
      - name: ‚¨ÜÔ∏è Upload Final Artifacts
        uses: actions/upload-artifact@v4
        if: ${{ steps.build_all.outputs.BUILD_STATUS == '0' }}
        with:
          name: zmk-firmware
          # Path uses the standard './build' directory
          path: ${{ github.workspace }}/build/zephyr/zmk.uf2
