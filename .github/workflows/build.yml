name: Build ZMK Firmware

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üßπ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Configure Git Safe Directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: üß± Setup Zephyr SDK
        uses: zmkfirmware/zmk-build-action@v1
        with:
          build-dir: zmk_workspace
          west-init-extra-args: --mr v0.3
          zephyr-version: v3.5.0+zmk-fixes

      - name: üß© Preflight Overlay Validation
        run: |
          echo "=== Checking DTS syntax ==="
          DTS_FILE="zmk_workspace/app/nice_nano_v2.overlay"
          if [ ! -f "$DTS_FILE" ]; then
            echo "‚ùå Overlay file missing: $DTS_FILE"
            exit 1
          fi
          grep -E 'compatible|map|row-gpios|col-gpios' "$DTS_FILE" || true
          dtc -I dts -O dtb -o /tmp/test.dtb "$DTS_FILE" 2>&1 | tee dts_check.log || {
            echo "‚ùå DTS parse failed! See dts_check.log"
            exit 1
          }

      - name: ü™∂ Patch Device Name Limit
        run: |
          DEVICE_H="zmk_workspace/zephyr/include/zephyr/device.h"
          echo "=== Checking device.h ==="
          grep -q "Z_DEVICE_MAX_NAME_LEN" "$DEVICE_H" && \
          sed -i 's/#define Z_DEVICE_MAX_NAME_LEN .*/#define Z_DEVICE_MAX_NAME_LEN 128/' "$DEVICE_H"
          grep Z_DEVICE_MAX_NAME_LEN "$DEVICE_H"

      - name: üß∞ Build Firmware
        run: |
          set -e
          echo "=== Environment ==="
          echo "PWD: $(pwd)"
          echo "ZMK Root: $ZMK_ROOT"
          echo "=== Starting build ==="
          west build -b nice_nano_v2 -p always app -- -DOVERLAY_CONFIG=prj.conf | tee build_output.log
        env:
          ZMK_ROOT: ${{ github.workspace }}/zmk_workspace

      - name: ‚úÖ Verify Build Artifacts
        run: |
          echo "=== Verifying artifacts ==="
          ls -lh zmk_workspace/build/zephyr || true
          if [ ! -f "zmk_workspace/build/zephyr/zmk.uf2" ]; then
            echo "‚ùå Firmware (.uf2) not found!"
            echo "Here‚Äôs a quick look at the last 20 lines of build_output.log:"
            tail -n 20 build_output.log
            exit 1
          fi
          echo "‚úÖ Firmware found and ready."

      - name: üì¶ Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: zmk_firmware
          path: zmk_workspace/build/zephyr/zmk.uf2
