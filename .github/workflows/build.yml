name: ZMK Resilient Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # Use the official ZMK Docker image
    container:
      image: zmkfirmware/zmk-build-arm:stable
    
    runs-on: ubuntu-latest
    
    # RESOLUTION 2: Explicitly grant permissions to resolve potential token/access issues 
    # when fetching external actions and content.
    permissions:
      contents: read 
      
    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # RESOLUTION 1: Use the correct, maintained path for the setup action.
      # This replaces all manual 'west init', 'west update', and 'source zephyr-env.sh' steps.
      - name: ⚙️ Set up ZMK Environment
        uses: zmkfirmware/zmk-helpers/actions/setup-zmk@main 
        # This action clones ZMK, runs west update, and sources the environment correctly.

      - name: ⚙️ Build ZMK Firmware (Simplified via Action)
        # The environment is already sourced, so we run west build directly.
        run: |
          west build -s zmk/app -b nice_nano_v2 -- -DSHIELD=crkbd_left -DZMK_CONFIG=$GITHUB_WORKSPACE/config || { echo "FATAL: West build failed. Review CMake output."; exit 1; }

      - name: ⬆️ Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success() # Only upload if the build succeeded
        with:
          name: zmk-firmware
          # The artifact path remains relative to the workspace root
          path: build/zephyr/zmk.uf2
