name: ZMK Resilient West Dependency Build (Finalized)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    container:
      image: zmkfirmware/zmk-build-arm:stable
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: ‚¨áÔ∏è Checkout Repository (Your Config)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: ‚öôÔ∏è West-Managed Build with Correct File Handling
        shell: bash
        run: |
          # --- Configuration Variables ---
          ZMK_REVISION="v0.3" 
          ZMK_CLONE_DIR="$GITHUB_WORKSPACE/app_clone" # Temporary ZMK application source clone
          ZMK_ROOT="$GITHUB_WORKSPACE/zmk_workspace" # The West workspace root (where build occurs)
          
          # --- 1. Tool Validation ---
          echo "--- 1. Validating West Tool ---"
          command -v west || { echo "FATAL: 'west' tool not found in container path."; exit 1; }
          
          # --- 2. Clone ZMK and Initialize West Workspace ---
          echo "--- 2. Cloning ZMK Application Source ---"
          git clone --branch "$ZMK_REVISION" https://github.com/zmkfirmware/zmk.git "$ZMK_CLONE_DIR" || { echo "FATAL: ZMK application clone failed."; exit 1; }

          echo "--- 3. Initializing West Workspace with Correct Manifest Path ---"
          mkdir -p "$ZMK_ROOT" || { echo "FATAL: Failed to create ZMK workspace directory."; exit 1; }
          
          # üöÄ FIX 1 (West Init): Correctly points to the manifest file inside the cloned repository's 'app' folder.
          west init -m "$ZMK_CLONE_DIR" --mr "$ZMK_REVISION" --mf app/west.yml "$ZMK_ROOT" || { 
            echo "FATAL: West initialization failed."
            exit 1 
          }

          # Enter the newly initialized workspace directory
          cd "$ZMK_ROOT" || { echo "FATAL: Failed to enter ZMK workspace."; exit 1; }
          
          # --- 4. Update Dependencies ---
          echo "--- 4. Updating Dependencies via West (Cloning Zephyr, MCUBoot, etc.) ---"
          west update || { echo "FATAL: West update failed. Dependency cloning failed."; exit 1; }
          
          # --- 5. Prepare Application and Custom Configuration ---
          echo "--- 5. Preparing Application Source and Custom Configuration ---"
          
          # Create the app directory in the workspace
          mkdir -p "$ZMK_ROOT/app" || { echo "FATAL: Failed to create app directory in workspace."; exit 1; }
          
          # üöÄ FIX 2 (Source Copy): Copies the CONTENTS of the NESTED 'app' folder (which contains CMakeLists.txt)
          # into the workspace's build folder. This solves the "doesn't contain a CMakeLists.txt" error.
          if [ -d "$ZMK_CLONE_DIR/app" ]; then
             cp -r "$ZMK_CLONE_DIR/app/"* "$ZMK_ROOT/app" || { echo "FATAL: Failed to copy ZMK app files."; exit 1; }
          else
             echo "FATAL: ZMK 'app' source directory not found in clone. Repository structure is unexpected."
             exit 1
          fi
          
          # Copy custom config files to the application source location
          if [ -f "$GITHUB_WORKSPACE/config/nice_nano_v2.overlay" ]; then
             cp "$GITHUB_WORKSPACE/config/nice_nano_v2.overlay" "$ZMK_ROOT/app/nice_nano_v2.overlay" || { echo "FATAL: Failed to copy custom overlay."; exit 1; }
             echo "TRACE: Copied custom nice_nano_v2.overlay into application source."
          else
             echo "WARNING: nice_nano_v2.overlay not found in config. Proceeding with default settings."
          fi
          
          # --- 6. Source Zephyr Environment ---
          echo "--- 6. Sourcing Zephyr Environment Variables ---"
          ZEPHYR_ENV_SCRIPT="$ZMK_ROOT/zephyr/zephyr-env.sh"
          if [ -f "$ZEPHYR_ENV_SCRIPT" ]; then
             . "$ZEPHYR_ENV_SCRIPT" || { echo "FATAL: zephyr-env.sh sourcing failed."; exit 1; }
             echo "TRACE: Zephyr environment sourced successfully."
          else
             echo "FATAL: zephyr-env.sh script not found."
             exit 1
          fi

          # --- 7. Build and Configure ---
          echo "--- 7. Starting Final West Build ---"
          
          # Use 'west build' targeting the app directory and the nice_nano_v2 board.
          west build -b nice_nano_v2 "$ZMK_ROOT/app" || { 
            echo "FATAL: West build failed. Compilation or DTS configuration error."
            exit 1
          }
          
      - name: ‚¨ÜÔ∏è Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: zmk-firmware
          path: ${{ github.workspace }}/zmk_workspace/build/zephyr/zmk.uf2

  artifact:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Download Final Firmware Artifact
        uses: actions/download-artifact@v4
        with:
          name: zmk-firmware
          path: ./firmware-artifacts
          
      - name: üì¶ Display Artifact Contents
        run: ls -lR ./firmware-artifacts
