name: ZMK Resilient Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # Use the ZMK build container
    container:
      image: zmkfirmware/zmk-build-arm:stable
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          # Ensure Git is configured for the workspace
          
      - name: üì¶ Initialize and Update West Workspace (Guaranteed Path)
        # This resolves the 'No such file' error by ensuring the west repositories are 
        # checked out directly into the workspace root.
        run: |
          echo "--- Initializing West Workspace at Root ---"
          # Use 'west init .' to initialize the current working directory as the workspace
          # The -l config tells west to find the manifest file in the 'config' folder
          west init -l config . || { echo "FATAL: west init failed. Check manifest errors."; exit 1; }
          
          echo "--- Updating Dependencies ---"
          west update || { echo "FATAL: west update failed. Check repository access/manifest."; exit 1; }
          
          echo "--- West initialization complete. zmk/zephyr/ is guaranteed to exist now. ---"
          
      - name: ‚öôÔ∏è Source Environment & Build Firmware
        # This step now runs AFTER west update has confirmed to run successfully
        run: |
          # 1. Source the environment script using the absolute workspace path
          echo "--- Sourcing Zephyr Environment ---"
          . $GITHUB_WORKSPACE/zmk/zephyr/zephyr-env.sh || { echo "FATAL: zephyr-env.sh failed to source. West update did not work."; exit 1; }
          
          # 2. Change directory and run the standard build
          echo "--- Starting West Build ---"
          cd zmk/app || { echo "FATAL: zmk/app directory not found."; exit 1; }
          west build -b nice_nano_v2 -- -DSHIELD=crkbd_left -DZMK_CONFIG=$GITHUB_WORKSPACE/config || { echo "FATAL: West build failed."; exit 1; }

      - name: ‚¨ÜÔ∏è Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: zmk-firmware
          path: zmk/app/build/zephyr/zmk.uf2
