name: ZMK Build:Direct Configuration (Final Debug)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
    permissions:
      contents: read

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõ† Install Devicetree Compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y device-tree-compiler

      - name: üöÄ West Setup
        shell: bash
        run: |
          ZMK_REVISION="v0.3"
          ZMK_CLONE_DIR="$GITHUB_WORKSPACE/app_clone"
          ZMK_ROOT="$GITHUB_WORKSPACE/zmk_workspace"
          CUSTOM_CONFIG_DIR="$GITHUB_WORKSPACE/config"
          BOARD_NAME="nice_nano_v2"

          # Clone ZMK and initialize workspace
          git clone --branch "$ZMK_REVISION" https://github.com/zmkfirmware/zmk.git "$ZMK_CLONE_DIR"
          mkdir -p "$ZMK_ROOT"
          west init -m "$ZMK_CLONE_DIR" --mr "$ZMK_REVISION" --mf app/west.yml "$ZMK_ROOT"
          cd "$ZMK_ROOT"
          west update
          mkdir -p "$ZMK_ROOT/app"

          # Copy app files, overlay, and keymap
          cp -r "$ZMK_CLONE_DIR/app/"* "$ZMK_ROOT/app"
          cp "$CUSTOM_CONFIG_DIR/$BOARD_NAME.overlay" "$ZMK_ROOT/app/$BOARD_NAME.overlay"
          cp "$CUSTOM_CONFIG_DIR/$BOARD_NAME.keymap" "$ZMK_ROOT/app/$BOARD_NAME.keymap"

      - name: üìù Dump Overlay Contents
        shell: bash
        run: |
          ZMK_ROOT="$GITHUB_WORKSPACE/zmk_workspace"
          BOARD_NAME="nice_nano_v2"
          OVERLAY_PATH="$ZMK_ROOT/app/$BOARD_NAME.overlay"

          if [ -f "$OVERLAY_PATH" ]; then
            echo "--- $BOARD_NAME.overlay ---"
            cat -n "$OVERLAY_PATH"
            echo "----------------------------------"
          else
            echo "‚ùå Overlay file not found: $OVERLAY_PATH"
            exit 1
          fi

      - name: ‚ö° Source Zephyr Environment
        shell: bash
        run: |
          ZMK_ROOT="$GITHUB_WORKSPACE/zmk_workspace"
          source "$ZMK_ROOT/zephyr/zephyr-env.sh"

      - name: üîç Validate Devicetree
        shell: bash
        run: |
          ZMK_ROOT="$GITHUB_WORKSPACE/zmk_workspace"
          BOARD_NAME="nice_nano_v2"
          OVERLAY_PATH="$ZMK_ROOT/app/$BOARD_NAME.overlay"
          DTS_TMP="$ZMK_ROOT/build/zephyr/zephyr.dts.tmp"

          mkdir -p "$ZMK_ROOT/build/zephyr"
          dtc -I dts -O dtb "$OVERLAY_PATH" -o "$DTS_TMP" && echo "‚úÖ Overlay devicetree valid." || echo "‚ùå Overlay devicetree compilation failed."

      - name: üöß Build ZMK Firmware
        shell: bash
        run: |
          ZMK_ROOT="$GITHUB_WORKSPACE/zmk_workspace"
          BOARD_NAME="nice_nano_v2"
          cd "$ZMK_ROOT"
          west build -b "$BOARD_NAME" app
