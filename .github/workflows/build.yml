name: ZMK Build (Stable Direct Config)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
    permissions:
      contents: read
      
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚ö†Ô∏è Fix Git Dubious Ownership
        shell: bash
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          
      - name: üß© Log ZMK & Zephyr Versions
        shell: bash
        run: |
          set -e
          echo "=== ZMK & Zephyr Version Info ==="
          # Log repo commit for main repo
          echo "--- Repository HEAD ---"
          git rev-parse HEAD
          git branch --show-current
          # If submodules exist, log their commits
          git submodule foreach 'echo $path `git rev-parse HEAD`'
          echo "--- Pinned West Manifest ---"
          if command -v west &> /dev/null; then
            west manifest --freeze || echo "‚ùå west manifest failed"
          fi
          echo "=============================="

      - name: üöÄ Setup, Build, and Extensive Logging
        id: build_run
        shell: bash
        run: |
          set -e
          # --- Configuration Variables ---
          ZMK_REVISION="v0.3"
          ZMK_CLONE_DIR="$GITHUB_WORKSPACE/app_clone"
          ZMK_ROOT="$GITHUB_WORKSPACE/zmk_workspace"
          CONFIG_DIR="$GITHUB_WORKSPACE/config"
          BOARD_NAME="nice_nano_v2"
          DTS_PATH="$ZMK_ROOT/build/zephyr/zephyr.dts"
          LOG_FILE="$GITHUB_WORKSPACE/build_debug.log"
          
          echo "üîß Setting up workspace..." | tee -a $LOG_FILE
          git clone --branch "$ZMK_REVISION" https://github.com/zmkfirmware/zmk.git "$ZMK_CLONE_DIR" | tee -a $LOG_FILE
          mkdir -p "$ZMK_ROOT"
          west init -m "$ZMK_CLONE_DIR" --mr "$ZMK_REVISION" --mf app/west.yml "$ZMK_ROOT" | tee -a $LOG_FILE
          
          cd "$ZMK_ROOT"
          west update | tee -a $LOG_FILE
          
          # Copy app files
          mkdir -p "$ZMK_ROOT/app"
          cp -r "$ZMK_CLONE_DIR/app/"* "$ZMK_ROOT/app" | tee -a $LOG_FILE
          cp "$CONFIG_DIR/$BOARD_NAME.keymap" "$ZMK_ROOT/app/$BOARD_NAME.keymap" | tee -a $LOG_FILE
          cp "$CONFIG_DIR/$BOARD_NAME.overlay" "$ZMK_ROOT/app/$BOARD_NAME.overlay" | tee -a $LOG_FILE
          
          echo "--- DUMPING $BOARD_NAME.overlay ---" | tee -a $LOG_FILE
          cat -n "$ZMK_ROOT/app/$BOARD_NAME.overlay" | tee -a $LOG_FILE
          echo "----------------------------------" | tee -a $LOG_FILE
          
          echo "üåø Sourcing Zephyr environment..." | tee -a $LOG_FILE
          . "$ZMK_ROOT/zephyr/zephyr-env.sh"
          
          echo "‚öôÔ∏è Starting west build..." | tee -a $LOG_FILE
          if west build -b $BOARD_NAME "$ZMK_ROOT/app" 2>&1 | tee -a $LOG_FILE; then
            echo "BUILD_STATUS=0" >> $GITHUB_ENV
            echo "‚úÖ Build completed successfully!" | tee -a $LOG_FILE
          else
            echo "BUILD_STATUS=1" >> $GITHUB_ENV
            echo "‚ùå Build failed!" | tee -a $LOG_FILE
          fi
          echo "--- Build status set to $BUILD_STATUS ---" | tee -a $LOG_FILE
          
          if [ "$BUILD_STATUS" -ne 0 ]; then
            echo "Dumping zephyr.dts if available..." | tee -a $LOG_FILE
            if [ -f "$DTS_PATH" ]; then
              cat -n "$DTS_PATH" | tee -a $LOG_FILE
            else
              echo "zephyr.dts not found ‚Äî build likely failed early." | tee -a $LOG_FILE
            fi
          fi

      - name: üíæ Upload Build Debug Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-debug-logs
          path: ${{ github.workspace }}/build_debug.log
          retention-days: 2

      - name: üíæ Upload Devicetree Debug Logs (on failure)
        if: env.BUILD_STATUS == '1'
        uses: actions/upload-artifact@v4
        with:
          name: devicetree-debug-logs
          path: ${{ github.workspace }}/zmk_workspace/build/zephyr/zephyr.dts.pre
          retention-days: 2

      - name: ‚¨ÜÔ∏è Upload Firmware (on success)
        if: env.BUILD_STATUS == '0'
        uses: actions/upload-artifact@v4
        with:
          name: zmk-firmware
          path: ${{ github.workspace }}/zmk_workspace/build/zephyr/zmk.uf2
