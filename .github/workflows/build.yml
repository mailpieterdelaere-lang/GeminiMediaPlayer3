name: Build GeminiMediaPlayer3

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    uses: zmkfirmware/zmk-build-action/.github/workflows/build-user-config.yml@main
    with:
      # Use the nice_nano_v2 board, as specified in your error logs
      board: nice_nano_v2
      
      # Since you are building a custom application without a shield, 
      # we pass a dummy 'none' shield to satisfy the action's requirements.
      shield: none
      
      # The application directory where your CMakeLists.txt and nice_nano_v2.overlay reside.
      app_dir: app
      
    secrets:
      # Optional: GitHub token usually included by default
      token: ${{ secrets.GITHUB_TOKEN }}
      
    # CRITICAL DEBUGGING STEP: Upload logs if the build fails
    # This overwrites the job definition from the reusable workflow only for the purpose of adding failure-specific steps
    steps:
      - name: Checkout ZMK Config
        uses: actions/checkout@v4
        with:
          path: config
      
      - name: Checkout ZMK Firmware
        uses: actions/checkout@v4
        with:
          repository: zmkfirmware/zmk
          path: zmk-firmware
      
      - name: Set up ZMK Environment
        run: |
          cd zmk-firmware
          west init -l app --mr zmk-v3.5.0 # Ensure version is correct
          west update
          pip3 install -r zephyr/scripts/requirements.txt
          
      - name: Build Application
        id: build_app
        run: |
          # The core build command
          west build -b nice_nano_v2 app
          
      # CRITICAL DEBUGGING LOG UPLOAD
      # This step is conditional and runs only IF the 'build_app' step fails
      - name: Upload Devicetree Preprocessor Logs (On Failure) ðŸ’¾
        uses: actions/upload-artifact@v4
        if: always() && failure()
        with:
          name: devicetree-debug-logs
          # Path to the build output directory where zephyr.dts.pre is located
          path: zmk-firmware/build/zephyr/zephyr.dts.pre 
          retention-days: 1
          
      - name: Upload ZMK Firmware .uf2 File
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: firmware
          path: zmk-firmware/build/zephyr/zmk.uf2
