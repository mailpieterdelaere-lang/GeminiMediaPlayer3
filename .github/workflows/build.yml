name: ZMK Build:Direct Configuration (Final Debug)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake ninja-build dtc python3 python3-pip

      - name: üêç Install West and Zephyr Python Packages
        run: |
          python3 -m pip install --upgrade pip
          pip3 install west

      - name: üöÄ Setup ZMK Workspace
        shell: bash
        run: |
          set -e

          # --- Configuration Variables ---
          ZMK_REVISION="v0.3"
          ZMK_CLONE_DIR="$GITHUB_WORKSPACE/app_clone"
          ZMK_ROOT="$GITHUB_WORKSPACE/zmk_workspace"
          CONFIG_DIR="$GITHUB_WORKSPACE/config"
          BOARD_NAME="nice_nano_v2"
          OVERLAY_SRC="$CONFIG_DIR/$BOARD_NAME.overlay"
          KEYMAP_SRC="$CONFIG_DIR/$BOARD_NAME.keymap"
          OVERLAY_DEST="$ZMK_ROOT/app/$BOARD_NAME.overlay"
          KEYMAP_DEST="$ZMK_ROOT/app/$BOARD_NAME.keymap"
          DTS_PATH="$ZMK_ROOT/build/zephyr/zephyr.dts"

          # --- Clone ZMK ---
          git clone --branch "$ZMK_REVISION" https://github.com/zmkfirmware/zmk.git "$ZMK_CLONE_DIR"

          # --- Init West Workspace ---
          mkdir -p "$ZMK_ROOT"
          cd "$ZMK_ROOT"
          west init -m "$ZMK_CLONE_DIR" --mr "$ZMK_REVISION" --mf app/west.yml
          west update

          # --- Copy app/ files ---
          mkdir -p "$ZMK_ROOT/app"
          cp -r "$ZMK_CLONE_DIR/app/"* "$ZMK_ROOT/app"
          cp "$OVERLAY_SRC" "$OVERLAY_DEST"
          cp "$KEYMAP_SRC" "$KEYMAP_DEST"

      - name: üåø Source Zephyr Environment
        shell: bash
        run: |
          . "$ZMK_ROOT/zephyr/zephyr-env.sh"

      - name: üìù Dump Overlay Contents
        shell: bash
        run: |
          echo "--- DUMPING $BOARD_NAME.overlay ---"
          cat -n "$OVERLAY_DEST"
          echo "-----------------------------------"

      - name: üîç Validate Devicetree
        shell: bash
        run: |
          echo "--- VALIDATING DEVICETREE ---"
          dtc -I dts -O dtb -o /tmp/test.dtb "$OVERLAY_DEST" && echo "‚úÖ Devicetree overlay valid." || echo "‚ùå Devicetree overlay invalid."

      - name: ‚ö° Build ZMK Firmware
        shell: bash
        run: |
          set -e
          cd "$ZMK_ROOT/app"
          west build -b $BOARD_NAME .

      - name: ‚¨ÜÔ∏è Upload Final Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: zmk-firmware
          path: ${{ github.workspace }}/zmk_workspace/build/zephyr/zmk.uf2
