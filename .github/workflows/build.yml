name: ZMK Fully Manual Dependency Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # Uses the official ZMK build environment container
    container:
      image: zmkfirmware/zmk-build-arm:stable
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: ⬇️ Checkout Repository (Your Config)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: ⚙️ Manual Git Clone, Setup, and Build
        # Use 'bash' shell to correctly source zephyr-env.sh and execute complex scripts.
        shell: bash
        run: |
          # --- Configuration Variables ---
          ZEPHYR_REVISION="v2.6.0" 
          MCUB_REVISION="v1.7.0"
          ZMK_REVISION="v0.3" 
          ZMK_REPO_ROOT="$GITHUB_WORKSPACE/zmk"
          
          # 1. Create the base ZMK structure
          echo "--- 1. Creating target directories ---"
          mkdir -p "$ZMK_REPO_ROOT/zephyr"
          mkdir -p "$ZMK_REPO_ROOT/app"
          mkdir -p "$ZMK_REPO_ROOT/bootloader/mcuboot"

          # 2. Clone Dependencies
          echo "--- 2. Cloning ZMK App (Path: zmk/app) ---"
          git clone --depth 1 --branch "$ZMK_REVISION" https://github.com/zmkfirmware/zmk.git "$ZMK_REPO_ROOT/app" || exit 1
          echo "--- 3. Cloning Zephyr RTOS (Path: zmk/zephyr) ---"
          git clone --depth 1 --branch "$ZEPHYR_REVISION" https://github.com/zephyrproject-rtos/zephyr.git "$ZMK_REPO_ROOT/zephyr" || exit 1
          echo "--- 4. Cloning MCUBoot (Path: zmk/bootloader/mcuboot) ---"
          git clone --depth 1 --branch "$MCUB_REVISION" https://github.com/mcu-tools/mcuboot.git "$ZMK_REPO_ROOT/bootloader/mcuboot" || exit 1

          # 5. Sourcing Zephyr Environment
          echo "--- 5. Sourcing Zephyr Environment Variables ---"
          . "$ZMK_REPO_ROOT/zephyr/zephyr-env.sh" || { echo "FATAL: zephyr-env.sh sourcing failed."; exit 1; }

          # 6. Build Setup and CMake Execution
          echo "--- 6. Starting Final CMake Build ---"
          
          # --- Path Definitions ---
          # CRITICAL FIX: The source code may be nested inside the cloned repository's 'app' folder.
          # We check the most likely location first, then use a fallback.
          APP_SOURCE_DIR="$ZMK_REPO_ROOT/app"
          BUILD_DIR="$APP_SOURCE_DIR/build"
          
          # 7. Backup Plan: Check for nested 'app' directory
          if [ -f "$APP_SOURCE_DIR/app/CMakeLists.txt" ]; then
             echo "TRACE: Found CMakeLists.txt in nested app directory. Adjusting source path."
             APP_SOURCE_DIR="$APP_SOURCE_DIR/app"
          elif [ ! -f "$APP_SOURCE_DIR/CMakeLists.txt" ]; then
             echo "FATAL: Cannot find CMakeLists.txt in either '$ZMK_REPO_ROOT/app' or '$ZMK_REPO_ROOT/app/app'."
             echo "Listing files in $ZMK_REPO_
