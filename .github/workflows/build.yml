name: ZMK Resilient West Dependency Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # Use the ZMK build container, which should have west pre-installed
    container:
      image: zmkfirmware/zmk-build-arm:stable
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: ⬇️ Checkout Repository (Your Config)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: ⚙️ West-Managed Build with Error Handling
        shell: bash
        run: |
          # --- Configuration Variables ---
          ZMK_REVISION="v0.3" 
          APP_REPO_DIR="$GITHUB_WORKSPACE/app_clone" # Temporary ZMK clone location
          ZMK_ROOT="$GITHUB_WORKSPACE/zmk_workspace" # The West workspace root
          
          # --- 1. Basic Tool Validation ---
          echo "--- 1. Validating West Tool ---"
          command -v west || { echo "FATAL: 'west' tool not found in container path."; exit 1; }
          echo "TRACE: 'west' tool is available."
          
          # --- 2. Initialize West Workspace and Clone ZMK ---
          echo "--- 2. Initializing West Workspace ---"
          mkdir -p "$ZMK_ROOT" || { echo "FATAL: Failed to create ZMK workspace directory."; exit 1; }
          cd "$ZMK_ROOT" || { echo "FATAL: Failed to enter ZMK workspace."; exit 1; }
          
          # Clone ZMK into a temp location for its manifest
          git clone --branch "$ZMK_REVISION" https://github.com/zmkfirmware/zmk.git "$APP_REPO_DIR" || { echo "FATAL: ZMK application clone failed."; exit 1; }

          # Initialize the west workspace using the manifest from the cloned app
          west init -m "$APP_REPO_DIR/west.yml" --mr "$ZMK_REVISION" || { echo "FATAL: West initialization failed. Manifest may be missing or incorrect for v0.3."; exit 1; }
          
          # --- 3. Update Dependencies ---
          echo "--- 3. Updating Dependencies via West ---"
          west update || { echo "FATAL: West update failed. Dependency cloning failed (network or manifest issue)."; exit 1; }
          
          # --- 4. Prepare Application and Custom Configuration ---
          echo "--- 4. Setting up Application Structure ---"
          
          # Create the final app folder and copy the ZMK source code into the west workspace
          mkdir -p "$ZMK_ROOT/app" || { echo "FATAL: Failed to create app directory in workspace."; exit 1; }
          cp -r "$APP_REPO_DIR/"* "$ZMK_ROOT/app" || { echo "FATAL: Failed to copy ZMK app files."; exit 1; }

          # Copy custom config files to the expected location for the build system
          if [ -f "$GITHUB_WORKSPACE/config/nice_nano_v2.overlay" ]; then
             cp "$GITHUB_WORKSPACE/config/nice_nano_v2.overlay" "$ZMK_ROOT/app/nice_nano_v2.overlay" || { echo "FATAL: Failed to copy custom overlay."; exit 1; }
             echo "TRACE: Copied custom nice_nano_v2.overlay into application source."
          else
             echo "WARNING: nice_nano_v2.overlay not found in config. Relying on default settings."
          fi
          
          # --- 5. Source Zephyr Environment ---
          echo "--- 5. Sourcing Zephyr Environment Variables ---"
          ZEPHYR_ENV_SCRIPT="$ZMK_ROOT/zephyr/zephyr-env.sh"
          if [ -f "$ZEPHYR_ENV_SCRIPT" ]; then
             . "$ZEPHYR_ENV_SCRIPT" || { echo "FATAL: zephyr-env.sh sourcing failed. Check script integrity."; exit 1; }
             echo "TRACE: Zephyr environment sourced successfully."
