name: ZMK Build:Direct Configuration (Bypassing Shield System)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
    permissions:
      contents: read
      
    steps:
      - name: ‚¨áÔ∏è Checkout Repository (Your Config)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ‚öôÔ∏è West Setup and Direct File Configuration
        id: west_setup
        shell: bash
        # Run everything from the default workspace root
        run: |
          # --- Configuration Variables ---
          ZMK_REVISION="v0.3"
          # Define the paths relative to the current workspace root
          ZMK_CLONE_DIR="./app_clone"
          ZMK_ROOT="./zmk_workspace"
          CUSTOM_CONFIG_DIR="./config"
          BOARD_NAME="nice_nano_v2"
          
          # 1. Initialize and Update West Workspace
          echo "--- 1. Setting up West Workspace ---"
          git clone --branch "$ZMK_REVISION" https://github.com/zmkfirmware/zmk.git "$ZMK_CLONE_DIR" || exit 1
          mkdir -p "$ZMK_ROOT"
          west init -m "$ZMK_CLONE_DIR" --mr "$ZMK_REVISION" --mf app/west.yml "$ZMK_ROOT" || exit 1
          
          # Change to the ZMK root directory for subsequent west commands
          cd "$ZMK_ROOT" || exit 1
          west update || exit 1
          
          # 2. Prepare Application Source
          echo "--- 2. Preparing Application Source and Configuration ---"
          mkdir -p "app"
          cp -r "$ZMK_CLONE_DIR/app/"* "app" || exit 1
          
          # 3. Copy/Patch Files DIRECTLY to Application Root
          echo "--- 3. Copying Files to App Root for Direct Discovery ---"
          # Copy all custom config files from the checked-out folder into the new app folder
          cp -r "$CUSTOM_CONFIG_DIR"/* "app/"
          
          # 4. Source Zephyr Environment
          echo "--- 4. Sourcing Zephyr Environment Variables ---"
          . "./zephyr/zephyr-env.sh" || { echo "FATAL: zephyr-env.sh sourcing failed."; exit 1; }
          
        # Set the working directory for the *next* steps to where ZMK was initialized
        working-directory: ${{ github.workspace }}/zmk_workspace

      - name: 5. Perform West Build
        id: build_app
        shell: bash
        # Run the build command
        run: |
          echo "--- 5. Starting Final West Build ---"
          west build -b nice_nano_v2 app
        continue-on-error: true # Allow flow to continue to the logging step if the build fails

      - name: üíæ Upload Devicetree Preprocessor Logs (On Failure)
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: devicetree-debug-logs
          # FIX: This path is now relative to the working-directory of the build step
          path: ${{ github.workspace }}/zmk_workspace/build/zephyr/zephyr.dts.pre
          retention-days: 1

      - name: ‚¨ÜÔ∏è Upload Final Artifacts
        uses: actions/upload-artifact@v4
        if: ${{ success() }}
        with:
          name: zmk-firmware
          path: ${{ github.workspace }}/zmk_workspace/build/zephyr/zmk.uf2
