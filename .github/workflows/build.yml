name: ZMK Build:Direct Configuration (Final Debug)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
    permissions:
      contents: read
      
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: üöÄ West Setup, Build, Devicetree Validation
        id: build_run
        shell: bash
        run: |
          set -euo pipefail

          # --- Configuration Variables ---
          ZMK_REVISION="v0.3"
          ZMK_CLONE_DIR="$GITHUB_WORKSPACE/app_clone"
          ZMK_ROOT="$GITHUB_WORKSPACE/zmk_workspace"
          CUSTOM_CONFIG_DIR="$GITHUB_WORKSPACE/config"
          BOARD_NAME="nice_nano_v2"
          OVERLAY_PATH="$ZMK_ROOT/app/$BOARD_NAME.overlay"
          DTS_PATH="$ZMK_ROOT/build/zephyr/zephyr.dts"
          DTS_PRE_PATH="$ZMK_ROOT/build/zephyr/zephyr.dts.pre"

          # --- 1. Initialize and Update West Workspace ---
          git clone --branch "$ZMK_REVISION" https://github.com/zmkfirmware/zmk.git "$ZMK_CLONE_DIR"
          mkdir -p "$ZMK_ROOT"
          west init -m "$ZMK_CLONE_DIR" --mr "$ZMK_REVISION" --mf app/west.yml "$ZMK_ROOT"
          cd "$ZMK_ROOT"
          west update
          mkdir -p "$ZMK_ROOT/app"
          cp -r "$ZMK_CLONE_DIR/app/"* "$ZMK_ROOT/app"
          cp "$CUSTOM_CONFIG_DIR/$BOARD_NAME.keymap" "$ZMK_ROOT/app/$BOARD_NAME.keymap"
          cp "$CUSTOM_CONFIG_DIR/$BOARD_NAME.overlay" "$ZMK_ROOT/app/$BOARD_NAME.overlay"

          # --- 2. Source Zephyr Environment ---
          echo "--- 2. Sourcing Zephyr Environment Variables ---"
          . "$ZMK_ROOT/zephyr/zephyr-env.sh"

          # --- 3. Dump Overlay Contents ---
          echo "--- 3. DUMPING $BOARD_NAME.overlay CONTENTS ---"
          cat -n "$OVERLAY_PATH"
          echo "----------------------------------------------------------------------"

          # --- 4. Devicetree Validation (Zephyr dtc) ---
          echo "--- 4. VALIDATING DEVICETREE ---"
          DTC_BIN="$ZMK_ROOT/zephyr/scripts/dtc/dtc"

          if [ ! -x "$DTC_BIN" ]; then
              echo "‚ùå dtc binary not found at $DTC_BIN"
          else
              mkdir -p "$(dirname "$DTS_PRE_PATH")"
              if "$DTC_BIN" -I dts -O dtb -o /dev/null "$OVERLAY_PATH"; then
                  echo "‚úÖ Overlay compiled successfully with Zephyr dtc."
              else
                  echo "‚ùå Overlay failed devicetree compilation with Zephyr dtc."
              fi

              # Preprocessor dump for debugging
              "$DTC_BIN" -I dts -O dts -o "$DTS_PRE_PATH" "$OVERLAY_PATH" || echo "(preprocessor dump failed)"
          fi
          echo "----------------------------------------------------------------------"

          # --- 5. Start Final West Build ---
          echo "--- 5. Starting Final West Build ---"
          set +e
          west build -b $BOARD_NAME "$ZMK_ROOT/app"
          BUILD_STATUS=$?
          set -e
          
          echo "BUILD_STATUS=$BUILD_STATUS" >> $GITHUB_OUTPUT

          # --- 6. Dump zephyr.dts for Debugging (If Build Fails) ---
          if [ $BUILD_STATUS -ne 0 ]; then
             echo "----------------------------------------------------------------------"
             echo "‚ùå WEST BUILD FAILED. Dumping zephyr.dts for debugging..."
             if [ -f "$DTS_PATH" ]; then
                 echo "--- BEGIN zephyr.dts ---"
                 cat -n "$DTS_PATH" || echo "(cat failed ‚Äî file unreadable)"
                 echo "--- END zephyr.dts ---"
             else
                 echo "zephyr.dts not found ‚Äî build likely failed before DTS generation."
             fi
             echo "----------------------------------------------------------------------"
          fi

          exit $BUILD_STATUS

      # üíæ Upload Devicetree Preprocessor Logs (On Failure)
      - name: üíæ Upload Devicetree Preprocessor Logs
        uses: actions/upload-artifact@v4
        if: ${{ steps.build_run.outputs.BUILD_STATUS != '0' }}
        with:
          name: devicetree-debug-logs
          path: ${{ github.workspace }}/zmk_workspace/build/zephyr/zephyr.dts.pre
          retention-days: 1

      # ‚¨ÜÔ∏è Upload Final Artifacts (If Build Succeeds)
      - name: ‚¨ÜÔ∏è Upload Final Artifacts
        uses: actions/upload-artifact@v4
        if: ${{ steps.build_run.outputs.BUILD_STATUS == '0' }}
        with:
          name: zmk-firmware
          path: ${{ github.workspace }}/zmk_workspace/build/zephyr/zmk.uf2
