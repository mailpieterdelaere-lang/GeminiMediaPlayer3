name: Build GeminiMediaPlayer3

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
      options: --user 1001:1001
      
    steps:
      - name: Checkout ZMK Config
        uses: actions/checkout@v4
        with:
          # Clones your config repository into the 'app' folder
          path: app
      
      - name: Checkout ZMK Firmware
        uses: actions/checkout@v4
        with:
          repository: zmkfirmware/zmk
          path: zmk-firmware
          # Use the latest stable tag (ZMK v3.5.0 uses Zephyr 3.5.0)
          ref: main 

      - name: Initialize and Update Modules
        run: |
          cd zmk-firmware
          # Initialize west with the application directory
          west init -l app --mr zmk-v3.5.0 
          west update
          pip3 install -r zephyr/scripts/requirements.txt
        # Set environment variables for the build
        env:
          ZEPHYR_TOOLCHAIN_VARIANT: zephyr
          ZEPHYR_SDK_INSTALL_DIR: /opt/zephyr-sdk

      - name: Perform West Build
        id: build_app
        # This command builds the application using the 'nice_nano_v2' board
        run: west build -b nice_nano_v2 app
        working-directory: zmk-firmware
        
      # CRITICAL DEBUGGING LOG UPLOAD (Runs ONLY IF the build fails)
      - name: Upload Devicetree Preprocessor Logs (On Failure) ðŸ’¾
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: devicetree-debug-logs
          # Path to the critical preprocessed file
          path: zmk-firmware/build/zephyr/zephyr.dts.pre
          retention-days: 1
          
      - name: Upload ZMK Firmware .uf2 File
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: firmware
          path: zmk-firmware/build/zephyr/zmk.uf2
